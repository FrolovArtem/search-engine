package searchengine.services;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.*;

@Slf4j
@Service
public class LemmaService {
    
    // Упрощенная лемматизация для русского языка
    // Для продакшена рекомендуется Apache Lucene Morphology
    
    private static final Set<String> STOP_WORDS = new HashSet<>(Arrays.asList(
        "и", "в", "во", "не", "что", "он", "на", "я", "с", "со", "как", "а", "то", "все",
        "она", "так", "его", "но", "да", "ты", "к", "у", "же", "вы", "за", "бы", "по",
        "только", "ее", "мне", "было", "вот", "от", "меня", "еще", "нет", "о", "из", "ему",
        "теперь", "когда", "даже", "ну", "вдруг", "ли", "если", "уже", "или", "ни", "быть",
        "был", "него", "до", "вас", "нибудь", "опять", "уж", "вам", "ведь", "там", "потом",
        "себя", "ничего", "ей", "может", "они", "тут", "где", "есть", "надо", "ней", "для",
        "мы", "тебя", "их", "чем", "была", "сам", "чтоб", "без", "будто", "чего", "раз",
        "тоже", "себе", "под", "будет", "ж", "тогда", "кто", "этот", "того", "потому",
        "этого", "какой", "совсем", "ним", "здесь", "этом", "один", "почти", "мой", "тем",
        "чтобы", "нее", "сейчас", "были", "куда", "зачем", "всех", "никогда", "можно",
        "при", "наконец", "два", "об", "другой", "хоть", "после", "над", "больше", "тот",
        "через", "эти", "нас", "про", "всего", "них", "какая", "много", "разве", "три",
        "эту", "моя", "впрочем", "хорошо", "свою", "этой", "перед", "иногда", "лучше",
        "чуть", "том", "нельзя", "такой", "им", "более", "всегда", "конечно", "всю", "между"
    ));
    
    public Map<String, Integer> getLemmas(String text) {
        Map<String, Integer> lemmas = new HashMap<>();
        
        String[] words = text.toLowerCase()
                .replaceAll("[^а-яa-zё\\s]", " ")
                .trim()
                .split("\\s+");
        
        for (String word : words) {
            if (word.isEmpty() || word.length() < 3) {
                continue;
            }
            
            // Проверяем только русские слова
            if (!word.matches("[а-яё]+")) {
                continue;
            }
            
            if (STOP_WORDS.contains(word)) {
                continue;
            }
            
            String lemma = lemmatize(word);
            lemmas.put(lemma, lemmas.getOrDefault(lemma, 0) + 1);
        }
        
        return lemmas;
    }
    
    private String lemmatize(String word) {
        if (word.length() < 4) {
            return word;
        }
        
        // Расширенный список окончаний для более точной лемматизации
        String[][] endings = {
            // Существительные множественного числа
            {"ами", "ями", "ах", "ях", "ам", "ям"},
            // Прилагательные
            {"ого", "его", "ому", "ему", "ыми", "ими"},
            // Глаголы
            {"ешь", "ете", "ишь", "ите", "ать", "ять", "еть", "ить", "ыть"},
            // Существительные и прилагательные
            {"ом", "ем", "им", "ой", "ей", "ий", "ый", "ая", "яя", "ое", "ее", "ые", "ие"},
            // Короткие окончания
            {"ов", "ев", "ам", "ми", "ах", "ой", "ей"},
            // Самые короткие
            {"а", "я", "у", "ю", "о", "е", "и", "ы", "ь"}
        };
        
        // Пробуем удалить окончания от длинных к коротким
        for (String[] endingGroup : endings) {
            for (String ending : endingGroup) {
                if (word.endsWith(ending) && word.length() - ending.length() >= 3) {
                    return word.substring(0, word.length() - ending.length());
                }
            }
        }
        
        return word;
    }
}
